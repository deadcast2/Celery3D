# Celery3D GPU - Timing Constraints for KC705 Evaluation Board
# Target: Xilinx Kintex-7 XC7K325T-2FFG900C

# ==============================================================================
# Input Clock - 50 MHz single-ended oscillator
# ==============================================================================
# TODO: Update pin location from board schematic
# The 50 MHz oscillator is typically on a dedicated clock-capable pin
create_clock -period 20.000 -name clk_50mhz [get_ports clk_50mhz_in]

# ==============================================================================
# GPU Core Clock - Target 50 MHz (20ns period)
# ==============================================================================
# Matches original Voodoo 1 clock speed and board's 50 MHz oscillator
create_clock -period 20.000 -name clk_gpu [get_ports clk]

# Clock uncertainty for setup/hold analysis
set_clock_uncertainty -setup 0.500 [get_clocks clk_gpu]
set_clock_uncertainty -hold 0.100 [get_clocks clk_gpu]

# ==============================================================================
# Timing Exceptions
# ==============================================================================
# Reset is async, treat as false path for timing
set_false_path -from [get_ports rst_n]

# ==============================================================================
# Input/Output Delays (placeholder values)
# ==============================================================================
# These will be refined based on actual board routing and connected peripherals

# Vertex input interface - assume synchronous to clk_gpu
set_input_delay -clock clk_gpu -max 2.0 [get_ports {v0_* v1_* v2_*}]
set_input_delay -clock clk_gpu -min 0.5 [get_ports {v0_* v1_* v2_*}]
set_input_delay -clock clk_gpu -max 2.0 [get_ports tri_valid]
set_input_delay -clock clk_gpu -min 0.5 [get_ports tri_valid]

# Fragment output interface
set_output_delay -clock clk_gpu -max 2.0 [get_ports {frag_out_*}]
set_output_delay -clock clk_gpu -min 0.5 [get_ports {frag_out_*}]
set_output_delay -clock clk_gpu -max 2.0 [get_ports frag_valid]
set_output_delay -clock clk_gpu -min 0.5 [get_ports frag_valid]

# Ready/busy signals
set_output_delay -clock clk_gpu -max 2.0 [get_ports tri_ready]
set_output_delay -clock clk_gpu -min 0.5 [get_ports tri_ready]
set_output_delay -clock clk_gpu -max 2.0 [get_ports busy]
set_output_delay -clock clk_gpu -min 0.5 [get_ports busy]

set_input_delay -clock clk_gpu -max 2.0 [get_ports frag_ready]
set_input_delay -clock clk_gpu -min 0.5 [get_ports frag_ready]

# ==============================================================================
# Physical Constraints (Placeholder - update from board schematic)
# ==============================================================================
# Pin assignments will be added once schematic is available
# For now, run synthesis-only to check timing on internal paths

# Example pin format (commented out until we have actual pinout):
# set_property PACKAGE_PIN <pin> [get_ports clk_50mhz_in]
# set_property IOSTANDARD LVCMOS33 [get_ports clk_50mhz_in]

# ==============================================================================
# HDMI Output (ADV7511 HDMI Transmitter)
# ==============================================================================
# From KC705 UG810 Table 1-21: FPGA to HDMI Codec Connections
# All signals are LVCMOS25

# HDMI Data Bus (16-bit YCbCr 4:2:2 to ADV7511 D[23:8])
set_property PACKAGE_PIN B23 [get_ports {hdmi_d[0]}]
set_property PACKAGE_PIN A23 [get_ports {hdmi_d[1]}]
set_property PACKAGE_PIN E23 [get_ports {hdmi_d[2]}]
set_property PACKAGE_PIN D23 [get_ports {hdmi_d[3]}]
set_property PACKAGE_PIN F25 [get_ports {hdmi_d[4]}]
set_property PACKAGE_PIN E25 [get_ports {hdmi_d[5]}]
set_property PACKAGE_PIN E24 [get_ports {hdmi_d[6]}]
set_property PACKAGE_PIN D24 [get_ports {hdmi_d[7]}]
set_property PACKAGE_PIN F26 [get_ports {hdmi_d[8]}]
set_property PACKAGE_PIN E26 [get_ports {hdmi_d[9]}]
set_property PACKAGE_PIN G23 [get_ports {hdmi_d[10]}]
set_property PACKAGE_PIN G24 [get_ports {hdmi_d[11]}]
set_property PACKAGE_PIN J19 [get_ports {hdmi_d[12]}]
set_property PACKAGE_PIN H19 [get_ports {hdmi_d[13]}]
set_property PACKAGE_PIN L17 [get_ports {hdmi_d[14]}]
set_property PACKAGE_PIN L18 [get_ports {hdmi_d[15]}]

set_property IOSTANDARD LVCMOS25 [get_ports {hdmi_d[*]}]

# HDMI Control Signals
set_property PACKAGE_PIN H17 [get_ports hdmi_de]
set_property PACKAGE_PIN K18 [get_ports hdmi_clk]
set_property PACKAGE_PIN H20 [get_ports hdmi_vsync]
set_property PACKAGE_PIN J18 [get_ports hdmi_hsync]

set_property IOSTANDARD LVCMOS25 [get_ports hdmi_de]
set_property IOSTANDARD LVCMOS25 [get_ports hdmi_clk]
set_property IOSTANDARD LVCMOS25 [get_ports hdmi_vsync]
set_property IOSTANDARD LVCMOS25 [get_ports hdmi_hsync]

# HDMI clock is generated by MMCM - set output constraints
set_property SLEW FAST [get_ports hdmi_clk]
set_property DRIVE 8 [get_ports hdmi_clk]

# ==============================================================================
# I2C Bus (for ADV7511 Configuration via PCA9548 Mux)
# ==============================================================================
# KC705 uses a PCA9548 I2C mux at address 0x74
# ADV7511 is on mux channel 5, I2C address 0x39 (0b0111001)
#
# Main I2C bus pins (directly to FPGA):
set_property PACKAGE_PIN K21 [get_ports i2c_scl]
set_property PACKAGE_PIN L21 [get_ports i2c_sda]

set_property IOSTANDARD LVCMOS25 [get_ports i2c_scl]
set_property IOSTANDARD LVCMOS25 [get_ports i2c_sda]

# I2C is open-drain, requires pull-ups (external on KC705)
set_property PULLUP true [get_ports i2c_scl]
set_property PULLUP true [get_ports i2c_sda]

# ==============================================================================
# 50 MHz System Clock (from KC705 User Clock)
# ==============================================================================
# KC705 has a 200 MHz differential oscillator on U4
# For 50 MHz, we'll use the programmable Si570 or divide the 200 MHz
# The User SMA clock or a different source may also be used
#
# Using the single-ended 200 MHz oscillator divided to 50 MHz:
# TODO: Verify the actual clock source for your application
set_property PACKAGE_PIN AD12 [get_ports clk_50mhz]
set_property IOSTANDARD LVCMOS25 [get_ports clk_50mhz]

# Input clock constraint
create_clock -period 20.000 -name clk_50mhz_in [get_ports clk_50mhz]

# ==============================================================================
# Pixel Clock Timing (MMCM Generated)
# ==============================================================================
# The pixel clock (25 MHz) is generated by MMCM from 50 MHz input
# Vivado will automatically derive the generated clock from the MMCM
# We just need to set output delays relative to it

# Create the generated pixel clock constraint
# (Vivado auto-derives this from MMCM, but explicit is better for documentation)
# Note: Path depends on hierarchy - will be auto-derived if not found
create_generated_clock -name pixel_clk \
    -source [get_pins -quiet */u_pixel_clk_gen/mmcm_inst/CLKIN1] \
    -divide_by 2 \
    [get_pins -quiet */u_pixel_clk_gen/mmcm_inst/CLKOUT0]

# HDMI output timing constraints
# ADV7511 samples data on rising edge of HDMI_CLK
# Data should be stable before the clock edge
set_output_delay -clock pixel_clk -max 2.0 [get_ports {hdmi_d[*]}]
set_output_delay -clock pixel_clk -min -1.0 [get_ports {hdmi_d[*]}]
set_output_delay -clock pixel_clk -max 2.0 [get_ports hdmi_de]
set_output_delay -clock pixel_clk -min -1.0 [get_ports hdmi_de]
set_output_delay -clock pixel_clk -max 2.0 [get_ports hdmi_hsync]
set_output_delay -clock pixel_clk -min -1.0 [get_ports hdmi_hsync]
set_output_delay -clock pixel_clk -max 2.0 [get_ports hdmi_vsync]
set_output_delay -clock pixel_clk -min -1.0 [get_ports hdmi_vsync]

# I2C is slow (100 kHz) - relax timing
set_false_path -to [get_ports i2c_scl]
set_false_path -to [get_ports i2c_sda]
set_false_path -from [get_ports i2c_scl]
set_false_path -from [get_ports i2c_sda]

# ==============================================================================
# Reset
# ==============================================================================
set_property PACKAGE_PIN AB7 [get_ports rst_n]
set_property IOSTANDARD LVCMOS15 [get_ports rst_n]
set_false_path -from [get_ports rst_n]

# ==============================================================================
# Synthesis Directives
# ==============================================================================
# Allow Vivado to optimize DSP inference for fixed-point multiplications
set_property DSP_STYLE block [get_cells -hierarchical -filter {PRIMITIVE_TYPE =~ DSP.*}] -quiet

# Target device
# set_property PART xc7k325t-2ffg676i [current_project]
